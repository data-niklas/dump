use std::cell::RefCell;

use magika::MagikaSession;
use phf::phf_map;

static CONTENT_TYPES: phf::Map<&'static str, (&'static str, &'static str)> = phf_map! {
"3gp" => ("application/unknown", "unknown"),
"ace" => ("application/unknown", "unknown"),
"aff" => ("application/unknown", "unknown"),
"ai" => ("application/pdf", "document"),
"algol68" => ("application/unknown", "unknown"),
"apk" => ("application/vnd.android.package-archive", "executable"),
"appleplist" => ("application/x-plist", "application"),
"arj" => ("application/unknown", "unknown"),
"asm" => ("text/x-asm", "code"),
"asp" => ("text/html", "code"),
"avi" => ("application/unknown", "unknown"),
"ax" => ("application/unknown", "unknown"),
"batch" => ("text/x-msdos-batch", "code"),
"bcad" => ("application/unknown", "unknown"),
"bib" => ("application/unknown", "unknown"),
"bmp" => ("image/bmp", "image"),
"bpl" => ("application/unknown", "unknown"),
"brainfuck" => ("application/unknown", "unknown"),
"bzip" => ("application/x-bzip2", "archive"),
"c" => ("text/x-c", "code"),
"cab" => ("application/vnd.ms-cab-compressed", "archive"),
"cad" => ("application/unknown", "unknown"),
"cat" => ("application/octet-stream", "application"),
"cdf" => ("application/unknown", "unknown"),
"chm" => ("application/chm", "application"),
"clojure" => ("application/unknown", "unknown"),
"cmake" => ("application/unknown", "unknown"),
"cobol" => ("application/unknown", "unknown"),
"coff" => ("application/x-coff", "executable"),
"coffee" => ("application/unknown", "unknown"),
"com" => ("application/x-dosexec", "unknown"),
"cpl" => ("application/x-dosexec", "executable"),
"cpp" => ("application/unknown", "unknown"),
"crx" => ("application/x-chrome-extension", "executable"),
"cs" => ("text/plain", "code"),
"css" => ("text/css", "code"),
"csv" => ("text/csv", "code"),
"ctl" => ("application/unknown", "unknown"),
"dart" => ("application/unknown", "unknown"),
"deb" => ("application/vnd.debian.binary-package", "archive"),
"dex" => ("application/x-android-dex", "executable"),
"dey" => ("application/x-android-dey", "unknown"),
"diff" => ("application/unknown", "unknown"),
"directory" => ("inode/directory", "inode"),
"dll" => ("application/x-dosexec", "executable"),
"dm" => ("application/unknown", "unknown"),
"dmg" => ("application/x-apple-diskimage", "archive"),
"doc" => ("application/msword", "document"),
"dockerfile" => ("application/unknown", "unknown"),
"docx" => ("application/vnd.openxmlformats-officedocument.wordprocessingml.document", "document"),
"dosmbr" => ("application/unknown", "unknown"),
"dylib" => ("application/x-mach-o", "executable"),
"elf" => ("application/x-executable-elf", "executable"),
"elixir" => ("application/unknown", "unknown"),
"emf" => ("application/octet-stream", "application"),
"eml" => ("message/rfc822", "text"),
"empty" => ("inode/x-empty", "inode"),
"epub" => ("application/epub+zip", "document"),
"erlang" => ("application/unknown", "unknown"),
"ese" => ("application/x-ms-ese", "unknown"),
"exe" => ("application/x-dosexec", "executable"),
"exp" => ("application/unknown", "unknown"),
"flac" => ("audio/flac", "audio"),
"fortran" => ("application/unknown", "unknown"),
"fpx" => ("application/unknown", "unknown"),
"gif" => ("image/gif", "image"),
"go" => ("text/x-golang", "code"),
"gpx" => ("application/unknown", "unknown"),
"groovy" => ("application/unknown", "unknown"),
"gzip" => ("application/gzip", "archive"),
"haskell" => ("application/unknown", "unknown"),
"hfs" => ("application/x-hfs", "unknown"),
"hlp" => ("application/winhlp", "application"),
"hta" => ("application/hta", "unknown"),
"html" => ("text/html", "code"),
"hve" => ("application/unknown", "unknown"),
"ico" => ("image/vnd.microsoft.icon", "image"),
"img" => ("application/unknown", "unknown"),
"ini" => ("text/plain", "text"),
"internetshortcut" => ("application/x-mswinurl", "application"),
"iosapp" => ("application/unknown", "unknown"),
"iso" => ("application/x-iso9660-image", "archive"),
"jar" => ("application/java-archive", "archive"),
"java" => ("text/x-java", "code"),
"javabytecode" => ("application/x-java-applet", "executable"),
"javascript" => ("application/javascript", "code"),
"jpeg" => ("image/jpeg", "image"),
"json" => ("application/json", "code"),
"julia" => ("application/unknown", "unknown"),
"ko" => ("application/x-executable-elf", "executable"),
"kotlin" => ("application/unknown", "unknown"),
"latex" => ("text/x-tex", "text"),
"lisp" => ("text/x-lisp", "code"),
"lnk" => ("application/x-ms-shortcut", "application"),
"lua" => ("application/unknown", "unknown"),
"m3u" => ("text/plain", "application"),
"macho" => ("application/x-mach-o", "executable"),
"maff" => ("application/unknown", "unknown"),
"makefile" => ("text/x-makefile", "code"),
"markdown" => ("text/markdown", "text"),
"matlab" => ("application/unknown", "unknown"),
"mht" => ("application/x-mimearchive", "code"),
"mkv" => ("application/unknown", "unknown"),
"mov" => ("application/unknown", "unknown"),
"mp3" => ("audio/mpeg", "audio"),
"mp4" => ("video/mp4", "video"),
"mscompress" => ("application/x-ms-compress-szdd", "archive"),
"msi" => ("application/x-msi", "archive"),
"mst" => ("application/unknown", "unknown"),
"msvisio" => ("application/vnd.ms-visio.drawing.main+xml", "unknown"),
"mui" => ("application/x-dosexec", "application"),
"mum" => ("text/xml", "application"),
"mun" => ("application/unknown", "unknown"),
"nim" => ("application/unknown", "unknown"),
"null" => ("application/unknown", "unknown"),
"object" => ("application/unknown", "unknown"),
"objectivec" => ("application/unknown", "unknown"),
"ocaml" => ("application/unknown", "unknown"),
"ocx" => ("application/x-dosexec", "executable"),
"odex" => ("application/x-executable-elf", "executable"),
"odp" => ("application/vnd.oasis.opendocument.presentation", "document"),
"ods" => ("application/vnd.oasis.opendocument.spreadsheet", "document"),
"odt" => ("application/vnd.oasis.opendocument.text", "document"),
"ogg" => ("audio/ogg", "audio"),
"ole" => ("application/unknown", "unknown"),
"ooxml" => ("application/unknown", "unknown"),
"outlook" => ("application/vnd.ms-outlook", "application"),
"palmos" => ("application/unknown", "unknown"),
"pascal" => ("application/unknown", "unknown"),
"pbm" => ("application/unknown", "unknown"),
"pcap" => ("application/vnd.tcpdump.pcap", "application"),
"pdf" => ("application/pdf", "document"),
"pebin" => ("application/x-dosexec", "executable"),
"pem" => ("application/x-pem-file", "application"),
"perl" => ("text/x-perl", "code"),
"pgpkey" => ("application/pgp-keys", "unknown"),
"php" => ("text/x-php", "code"),
"png" => ("image/png", "image"),
"postscript" => ("application/postscript", "document"),
"powershell" => ("application/x-powershell", "code"),
"ppt" => ("application/vnd.ms-powerpoint", "document"),
"pptx" => ("application/vnd.openxmlformats-officedocument.presentationml.presentation", "document"),
"printfox" => ("application/unknown", "unknown"),
"prolog" => ("application/unknown", "unknown"),
"pub" => ("application/x-mspublisher", "unknown"),
"python" => ("text/x-python", "code"),
"pythonbytecode" => ("application/x-bytecode.python", "executable"),
"pythonpar" => ("application/unknown", "unknown"),
"r" => ("application/unknown", "unknown"),
"randombytes" => ("application/octet-stream", "unknown"),
"rar" => ("application/x-rar", "archive"),
"rdf" => ("application/rdf+xml", "text"),
"rll" => ("application/unknown", "unknown"),
"rpm" => ("application/x-rpm", "archive"),
"rst" => ("text/x-rst", "text"),
"rtf" => ("text/rtf", "text"),
"ruby" => ("application/x-ruby", "code"),
"rust" => ("application/x-rust", "code"),
"s" => ("application/unknown", "unknown"),
"scala" => ("application/x-scala", "code"),
"scr" => ("application/x-dosexec", "executable"),
"scriptwsf" => ("application/unknown", "unknown"),
"sevenzip" => ("application/x-7z-compressed", "archive"),
"sgml" => ("application/unknown", "unknown"),
"sh3d" => ("application/unknown", "unknown"),
"shell" => ("text/x-shellscript", "code"),
"smali" => ("application/x-smali", "code"),
"so" => ("application/x-executable-elf", "executable"),
"sql" => ("application/x-sql", "code"),
"squashfs" => ("application/octet-stream", "archive"),
"svd" => ("application/unknown", "unknown"),
"svg" => ("image/svg+xml", "image"),
"swf" => ("application/x-shockwave-flash", "executable"),
"swift" => ("application/unknown", "unknown"),
"symlinktext" => ("text/plain", "application"),
"symlink" => ("inode/symlink", "inode"),
"sys" => ("application/x-windows-driver", "executable"),
"tar" => ("application/x-tar", "archive"),
"tga" => ("image/x-tga", "image"),
"tiff" => ("image/tiff", "image"),
"tmdx" => ("application/unknown", "unknown"),
"toml" => ("application/unknown", "unknown"),
"torrent" => ("application/x-bittorrent", "application"),
"troff" => ("application/unknown", "unknown"),
"ttf" => ("font/sfnt", "font"),
"txt" => ("text/plain", "text"),
"typescript" => ("application/unknown", "unknown"),
"udf" => ("application/x-udf-image", "unknown"),
"unixcompress" => ("application/x-compress", "unknown"),
"unknown" => ("application/octet-stream", "unknown"),
"vba" => ("text/vbscript", "code"),
"verilog" => ("application/unknown", "unknown"),
"vhd" => ("application/x-vhd", "unknown"),
"wasm" => ("application/unknown", "unknown"),
"wav" => ("audio/x-wav", "audio"),
"webm" => ("video/webm", "video"),
"webp" => ("image/webp", "image"),
"winregistry" => ("text/x-ms-regedit", "application"),
"wmf" => ("image/wmf", "image"),
"woff" => ("application/unknown", "unknown"),
"xar" => ("application/x-xar", "archive"),
"xls" => ("application/vnd.ms-excel", "document"),
"xlsb" => ("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "document"),
"xlsx" => ("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", "document"),
"xml" => ("text/xml", "code"),
"xpi" => ("application/zip", "archive"),
"xz" => ("application/x-xz", "archive"),
"yaml" => ("application/x-yaml", "code"),
"zip" => ("application/zip", "archive"),
"zlibstream" => ("application/zlib", "application")

};

thread_local! {
    static MODEL: RefCell<Option<MagikaSession>> = RefCell::new(None);
}

// Returns the label, mime and group
pub fn identify(data_directory: &std::path::Path, bytes: &[u8]) -> (String, String, String) {
    MODEL.with(|model_cell| {
        let mut model = model_cell.borrow_mut();
        if model.is_none() {
            let model_directory = data_directory.join("model");
            *model = Some(MagikaSession::build().build(model_directory).unwrap());
        }
        let model = model.as_mut().unwrap();
        let label = model.identify(bytes).unwrap().label().to_string();
        let (mime, group) = CONTENT_TYPES.get(&label).unwrap();
        (label, mime.to_string(), group.to_string())
    })
}
